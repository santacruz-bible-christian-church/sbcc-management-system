name: CI Required

# This workflow runs on PRs and waits for the actual CI workflows to complete.
# Set "All CI Passed" as the ONLY required status check in branch protection.

on:
  pull_request:
    branches: [main]

jobs:
  # Wait for Backend CI if backend files changed
  backend-gate:
    name: Backend Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check if backend files changed
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend-ci.yml'

      - name: Wait for Backend CI
        if: steps.filter.outputs.backend == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-backend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Django Tests"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Backend CI Result
        if: steps.filter.outputs.backend == 'true'
        run: |
          if [[ "${{ steps.wait-backend.outputs.conclusion }}" != "success" ]]; then
            echo "❌ Backend CI failed or timed out"
            exit 1
          fi
          echo "✅ Backend CI passed"

      - name: No backend changes
        if: steps.filter.outputs.backend == 'false'
        run: echo "⏭️ No backend files changed - skipping backend gate"

  # Wait for Frontend CI if frontend files changed
  frontend-gate:
    name: Frontend Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check if frontend files changed
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend-ci.yml'

      - name: Wait for Frontend CI
        if: steps.filter.outputs.frontend == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-frontend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Lint & Build"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Frontend CI Result
        if: steps.filter.outputs.frontend == 'true'
        run: |
          if [[ "${{ steps.wait-frontend.outputs.conclusion }}" != "success" ]]; then
            echo "❌ Frontend CI failed or timed out"
            exit 1
          fi
          echo "✅ Frontend CI passed"

      - name: No frontend changes
        if: steps.filter.outputs.frontend == 'false'
        run: echo "⏭️ No frontend files changed - skipping frontend gate"

  # Wait for Docker CI if docker files changed
  docker-gate:
    name: Docker Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check if docker files changed
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            docker:
              - 'backend/Dockerfile'
              - 'frontend/Dockerfile'
              - 'docker-compose.yml'
              - '.dockerignore'
              - '.github/workflows/docker-ci.yml'

      - name: Wait for Docker CI - Backend
        if: steps.filter.outputs.docker == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-docker-backend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Build Backend Image"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Wait for Docker CI - Frontend
        if: steps.filter.outputs.docker == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-docker-frontend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Build Frontend Image"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Docker CI Result
        if: steps.filter.outputs.docker == 'true'
        run: |
          if [[ "${{ steps.wait-docker-backend.outputs.conclusion }}" != "success" ]] || \
             [[ "${{ steps.wait-docker-frontend.outputs.conclusion }}" != "success" ]]; then
            echo "❌ Docker CI failed or timed out"
            exit 1
          fi
          echo "✅ Docker CI passed"

      - name: No docker changes
        if: steps.filter.outputs.docker == 'false'
        run: echo "⏭️ No docker files changed - skipping docker gate"

  # Final aggregated status - this is the ONLY required check
  all-ci-passed:
    name: All CI Passed
    runs-on: ubuntu-latest
    needs: [backend-gate, frontend-gate, docker-gate]
    if: always()
    steps:
      - name: Check all gates
        run: |
          echo "Backend Gate: ${{ needs.backend-gate.result }}"
          echo "Frontend Gate: ${{ needs.frontend-gate.result }}"
          echo "Docker Gate: ${{ needs.docker-gate.result }}"

          if [[ "${{ needs.backend-gate.result }}" == "failure" ]] || \
             [[ "${{ needs.frontend-gate.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-gate.result }}" == "failure" ]]; then
            echo ""
            echo "❌ One or more CI checks failed!"
            echo "Check the individual workflow runs for details."
            exit 1
          fi

          echo ""
          echo "✅ All applicable CI checks passed!"
