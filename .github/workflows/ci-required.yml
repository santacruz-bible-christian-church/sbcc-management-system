name: CI Required

# Aggregates all CI results into a single required status check.
# Set "All CI Passed" as the ONLY required check in branch protection.

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: read
  checks: read

jobs:
  gate:
    name: All CI Passed
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend-ci.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend-ci.yml'
            docker:
              - 'backend/Dockerfile'
              - 'frontend/Dockerfile'
              - 'docker-compose.yml'
              - '.dockerignore'
              - '.github/workflows/docker-ci.yml'

      # Wait for Backend CI
      - name: Wait for Backend CI
        if: steps.filter.outputs.backend == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-backend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Lint, Test & Coverage"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Verify Backend CI
        if: steps.filter.outputs.backend == 'true' && steps.wait-backend.outputs.conclusion != 'success'
        run: |
          echo "‚ùå Backend CI failed"
          exit 1

      # Wait for Frontend CI
      - name: Wait for Frontend CI
        if: steps.filter.outputs.frontend == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-frontend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Lint & Build"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Verify Frontend CI
        if: steps.filter.outputs.frontend == 'true' && steps.wait-frontend.outputs.conclusion != 'success'
        run: |
          echo "‚ùå Frontend CI failed"
          exit 1

      # Wait for Frontend E2E CI
      - name: Wait for Frontend E2E CI
        if: steps.filter.outputs.frontend == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-frontend-e2e
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "E2E Smoke (Chromium)"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Verify Frontend E2E CI
        if: steps.filter.outputs.frontend == 'true' && steps.wait-frontend-e2e.outputs.conclusion != 'success'
        run: |
          echo "‚ùå Frontend E2E CI failed"
          exit 1

      # Wait for Docker CI
      - name: Wait for Docker Backend Image
        if: steps.filter.outputs.docker == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-docker-backend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Build Backend Image"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Wait for Docker Frontend Image
        if: steps.filter.outputs.docker == 'true'
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-docker-frontend
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: "Build Frontend Image"
          ref: ${{ github.event.pull_request.head.sha }}
          timeoutSeconds: 600
          intervalSeconds: 10

      - name: Verify Docker CI
        if: steps.filter.outputs.docker == 'true' && (steps.wait-docker-backend.outputs.conclusion != 'success' || steps.wait-docker-frontend.outputs.conclusion != 'success')
        run: |
          echo "‚ùå Docker CI failed"
          exit 1

      # Summary
      - name: CI Summary
        run: |
          echo "üìä CI Results:"
          echo "  Backend: ${{ steps.filter.outputs.backend == 'true' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
          echo "  Frontend: ${{ steps.filter.outputs.frontend == 'true' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
          echo "  Frontend E2E: ${{ steps.filter.outputs.frontend == 'true' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
          echo "  Docker: ${{ steps.filter.outputs.docker == 'true' && '‚úÖ Passed' || '‚è≠Ô∏è Skipped' }}"
          echo ""
          echo "‚úÖ All applicable CI checks passed!"
